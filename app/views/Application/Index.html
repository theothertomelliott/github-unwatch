{{set . "title" "Home"}}
{{template "header.html" .}}

{{if .me}}
<h3>You're {{.me.Name}} on GitHub</h3>

<h1>Watched Repos</h1>


<div id="app">

	<!-- Modal -->
	<div id="unsubModal" class="modal fade" role="dialog">
		<div class="modal-dialog">
			<!-- Modal content-->
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title">Unsubscribing</h4>
				</div>
				<div class="modal-body">
						${workingRepoPercent}% complete<br/>
					<div class="progress">
						<div class="progress-bar" role="progressbar" v-bind:aria-valuenow="workingRepoPercent" aria-valuemin="0" aria-valuemax="100" style="width: ${workingRepoPercent}%;">							<span class="sr-only">60% Complete</span>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<div class="row">
	<div class="col-lg-12">
		<div class="input-group">
			<input type="text" class="form-control" placeholder="Search for..." v-model="searchQuery">
			<!-- For some reason this stretches it to the end -->
			<span class="input-group-btn">
				<button class="btn btn-default" type="button">Go!</button>
			</span>
		</div><!-- /input-group -->
	</div><!-- /.col-lg-12 -->
</div><!-- /.row -->

<br/><br/>

<div id="example">
	<a href="#" v-on:click="unsubscribe">Unsubscribe from ${filteredRepos.length} repositories</a>
</div>

	<div class="row">
	<ul class="list-group">
		<li  class="list-group-item" v-for="repo in filteredRepos">
			${ repo.name }
		</li>

	</ul>
	</div>

	<br/><br/>

	<div class="row">
	<ul class="list-group">
		<li  class="list-group-item" v-for="org in orgsByLogin | filterBy searchQuery in 'login'">
			<span class="badge">${ org.repoCount}</span>
			<span data-toggle="collapse" data-target="#list${org.login}" class="accordion-toggle">
				${ org.login } - ${ org.repoCount }
			</span>
			<a href="/Application/Unsubscribe?login=${org.login}">[Unsubscribe all]</a>
			<ul class="list-group accordian-body collapse" id="list${org.login}">
				<li class="list-group-item" v-for="repo in org.repos">
					 ${ repo.name }
				</li>
		</li>
	</ul>
	</div>
</div>


{{end}}

<script>

Vue.config.delimiters = ["${", "}"]

new Vue({
	notReady: function() {
		// GET request
		this.$http({url: '/Api/Unsubscribe', method: 'GET'}).then(function (response) {
			// success callback
			alert("Success: " + response);
			console.log(response);
		}, function (response) {
			// error callback
			alert("Failure:" + response);
		});
	},
	el: '#app',
	data: {
		searchQuery: '',
		unsubscribing: false,
		totalWorkingRepos: 0,
		workingReposComplete: 0,
		orgsByLogin: [
{{if .watchedByLogin}}
	{{ range $login, $repos := .watchedByLogin }}
		{
		  login: '{{$login}}',
		  repoCount: {{ len $repos }},
		  repos: [
		  	{{ range $repos }}
		  	{
				name: "{{.FullName}}",
				login: "{{$login}}"
		       	},
		  	{{ end }}
		  ]
		},
	{{end}}
{{end}}
		],
		repos: [
{{if .watchedByLogin}}
	{{ range $login, $repos := .watchedByLogin }}
		  	{{ range $repos }}
		  	{
				name: "{{.FullName}}",
				shortName: "{{.Name}}",
				login: "{{$login}}"
			},
		  	{{ end }}
	{{end}}
{{end}}
		]
	},
	methods: {
		unsubscribe: function(event){
			$('#unsubModal').modal('show');
			//$('#unsubModal').modal('hide');
				this.totalWorkingRepos = this.filteredRepos.length;
				this.workingReposComplete = 0;
				console.log(this.filteredRepos);
				for(repo in this.filteredRepos){
					r = this.filteredRepos[repo]
					console.log(r)
					this.$http({url: '/Api/Unsubscribe?repo=' + r.shortName + "&owner=" + r.login, method: 'GET'}).then(function (response) {
					// success callback
					console.log(response);
					this.workingReposComplete++;
				}, function (response) {
					// error callback
					alert("Failure:" + response);
					this.workingReposComplete++;
				});
			}
		}
	},

	computed: {
		filteredRepos: function () {
			return this.repos.filter(function(repo){
				return repo.name.indexOf(this.searchQuery) > -1;
			}.bind(this));
		},
		workingRepoPercent: function(){
			return (this.workingReposComplete / this.totalWorkingRepos) * 100;
		}
	}
});

</script>

{{template "footer.html" .}}
